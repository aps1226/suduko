f76d04a3b031d221da427438ede4f721
var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.Asset = void 0;

var _regenerator = _interopRequireDefault(require("@babel/runtime/regenerator"));

var _classCallCheck2 = _interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));

var _createClass2 = _interopRequireDefault(require("@babel/runtime/helpers/createClass"));

var _core = require("@unimodules/core");

var _AssetRegistry = require("./AssetRegistry");

var AssetSources = _interopRequireWildcard(require("./AssetSources"));

var AssetUris = _interopRequireWildcard(require("./AssetUris"));

var _EmbeddedAssets = require("./EmbeddedAssets");

var ImageAssets = _interopRequireWildcard(require("./ImageAssets"));

var _PlatformUtils = require("./PlatformUtils");

var _resolveAssetSource2 = _interopRequireDefault(require("./resolveAssetSource"));

function _getRequireWildcardCache(nodeInterop) { if (typeof WeakMap !== "function") return null; var cacheBabelInterop = new WeakMap(); var cacheNodeInterop = new WeakMap(); return (_getRequireWildcardCache = function _getRequireWildcardCache(nodeInterop) { return nodeInterop ? cacheNodeInterop : cacheBabelInterop; })(nodeInterop); }

function _interopRequireWildcard(obj, nodeInterop) { if (!nodeInterop && obj && obj.__esModule) { return obj; } if (obj === null || typeof obj !== "object" && typeof obj !== "function") { return { default: obj }; } var cache = _getRequireWildcardCache(nodeInterop); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (key !== "default" && Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj.default = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

var Asset = function () {
  function Asset(_ref) {
    var name = _ref.name,
        type = _ref.type,
        _ref$hash = _ref.hash,
        hash = _ref$hash === void 0 ? null : _ref$hash,
        uri = _ref.uri,
        width = _ref.width,
        height = _ref.height;
    (0, _classCallCheck2.default)(this, Asset);
    this.hash = null;
    this.localUri = null;
    this.width = null;
    this.height = null;
    this.downloading = false;
    this.downloaded = false;
    this._downloadCallbacks = [];
    this.name = name;
    this.type = type;
    this.hash = hash;
    this.uri = uri;

    if (typeof width === 'number') {
      this.width = width;
    }

    if (typeof height === 'number') {
      this.height = height;
    }

    if (hash) {
      this.localUri = (0, _EmbeddedAssets.getEmbeddedAssetUri)(hash, type);

      if (this.localUri) {
        this.downloaded = true;
      }
    }

    if (_core.Platform.OS === 'web') {
      if (!name) {
        this.name = AssetUris.getFilename(uri);
      }

      if (!type) {
        this.type = AssetUris.getFileExtension(uri);
      }
    }
  }

  (0, _createClass2.default)(Asset, [{
    key: "downloadAsync",
    value: function downloadAsync() {
      var _this = this;

      var _await$ImageAssets$ge, width, height, name;

      return _regenerator.default.async(function downloadAsync$(_context) {
        while (1) {
          switch (_context.prev = _context.next) {
            case 0:
              if (!this.downloaded) {
                _context.next = 2;
                break;
              }

              return _context.abrupt("return", this);

            case 2:
              if (!this.downloading) {
                _context.next = 6;
                break;
              }

              _context.next = 5;
              return _regenerator.default.awrap(new Promise(function (resolve, reject) {
                _this._downloadCallbacks.push({
                  resolve: resolve,
                  reject: reject
                });
              }));

            case 5:
              return _context.abrupt("return", this);

            case 6:
              this.downloading = true;
              _context.prev = 7;

              if (!(_core.Platform.OS === 'web')) {
                _context.next = 22;
                break;
              }

              if (!ImageAssets.isImageType(this.type)) {
                _context.next = 21;
                break;
              }

              _context.next = 12;
              return _regenerator.default.awrap(ImageAssets.getImageInfoAsync(this.uri));

            case 12:
              _await$ImageAssets$ge = _context.sent;
              width = _await$ImageAssets$ge.width;
              height = _await$ImageAssets$ge.height;
              name = _await$ImageAssets$ge.name;
              this.width = width;
              this.height = height;
              this.name = name;
              _context.next = 22;
              break;

            case 21:
              this.name = AssetUris.getFilename(this.uri);

            case 22:
              _context.next = 24;
              return _regenerator.default.awrap((0, _PlatformUtils.downloadAsync)(this.uri, this.hash, this.type, this.name));

            case 24:
              this.localUri = _context.sent;
              this.downloaded = true;

              this._downloadCallbacks.forEach(function (_ref2) {
                var resolve = _ref2.resolve;
                return resolve();
              });

              _context.next = 33;
              break;

            case 29:
              _context.prev = 29;
              _context.t0 = _context["catch"](7);

              this._downloadCallbacks.forEach(function (_ref3) {
                var reject = _ref3.reject;
                return reject(_context.t0);
              });

              throw _context.t0;

            case 33:
              _context.prev = 33;
              this.downloading = false;
              this._downloadCallbacks = [];
              return _context.finish(33);

            case 37:
              return _context.abrupt("return", this);

            case 38:
            case "end":
              return _context.stop();
          }
        }
      }, null, this, [[7, 29, 33, 37]], Promise);
    }
  }], [{
    key: "loadAsync",
    value: function loadAsync(moduleId) {
      var moduleIds = Array.isArray(moduleId) ? moduleId : [moduleId];
      return Promise.all(moduleIds.map(function (moduleId) {
        return Asset.fromModule(moduleId).downloadAsync();
      }));
    }
  }, {
    key: "fromModule",
    value: function fromModule(virtualAssetModule) {
      if (typeof virtualAssetModule === 'string') {
        return Asset.fromURI(virtualAssetModule);
      }

      var meta = (0, _AssetRegistry.getAssetByID)(virtualAssetModule);

      if (!meta) {
        throw new Error("Module \"" + virtualAssetModule + "\" is missing from the asset registry");
      }

      if (!_PlatformUtils.IS_ENV_WITH_UPDATES_ENABLED) {
        var _resolveAssetSource = (0, _resolveAssetSource2.default)(virtualAssetModule),
            uri = _resolveAssetSource.uri;

        var asset = new Asset({
          name: meta.name,
          type: meta.type,
          hash: meta.hash,
          uri: uri,
          width: meta.width,
          height: meta.height
        });

        if (_core.Platform.OS === 'android' && !uri.includes(':') && (meta.width || meta.height)) {
          asset.localUri = asset.uri;
          asset.downloaded = true;
        }

        Asset.byHash[meta.hash] = asset;
        return asset;
      }

      return Asset.fromMetadata(meta);
    }
  }, {
    key: "fromMetadata",
    value: function fromMetadata(meta) {
      var metaHash = meta.hash;

      if (Asset.byHash[metaHash]) {
        return Asset.byHash[metaHash];
      }

      var _AssetSources$selectA = AssetSources.selectAssetSource(meta),
          uri = _AssetSources$selectA.uri,
          hash = _AssetSources$selectA.hash;

      var asset = new Asset({
        name: meta.name,
        type: meta.type,
        hash: hash,
        uri: uri,
        width: meta.width,
        height: meta.height
      });
      Asset.byHash[metaHash] = asset;
      return asset;
    }
  }, {
    key: "fromURI",
    value: function fromURI(uri) {
      if (Asset.byUri[uri]) {
        return Asset.byUri[uri];
      }

      var type = '';

      if (uri.indexOf(';base64') > -1) {
        type = uri.split(';')[0].split('/')[1];
      } else {
        var extension = AssetUris.getFileExtension(uri);
        type = extension.startsWith('.') ? extension.substring(1) : extension;
      }

      var asset = new Asset({
        name: '',
        type: type,
        hash: null,
        uri: uri
      });
      Asset.byUri[uri] = asset;
      return asset;
    }
  }]);
  return Asset;
}();

exports.Asset = Asset;
Asset.byHash = {};
Asset.byUri = {};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,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R0FBRyxTQUFTLENBQUMsZ0JBQVYsQ0FBMkIsR0FBM0IsQ0FBbEI7QUFDQSxRQUFBLElBQUksR0FBRyxTQUFTLENBQUMsVUFBVixDQUFxQixHQUFyQixJQUE0QixTQUFTLENBQUMsU0FBVixDQUFvQixDQUFwQixDQUE1QixHQUFxRCxTQUE1RDtBQUNEOztBQUVELFVBQU0sS0FBSyxHQUFHLElBQUksS0FBSixDQUFVO0FBQ3RCLFFBQUEsSUFBSSxFQUFFLEVBRGdCO0FBRXRCLFFBQUEsSUFBSSxFQUFKLElBRnNCO0FBR3RCLFFBQUEsSUFBSSxFQUFFLElBSGdCO0FBSXRCLFFBQUEsR0FBRyxFQUFIO0FBSnNCLE9BQVYsQ0FBZDtBQU9BLE1BQUEsS0FBSyxDQUFDLEtBQU4sQ0FBWSxHQUFaLElBQW1CLEtBQW5CO0FBRUEsYUFBTyxLQUFQO0FBQ0Q7Ozs7OztBQXJJTSxLQUFBLENBQUEsTUFBQSxHQUFTLEVBQVQ7QUFDQSxLQUFBLENBQUEsS0FBQSxHQUFRLEVBQVIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBQbGF0Zm9ybSB9IGZyb20gJ0B1bmltb2R1bGVzL2NvcmUnO1xuXG5pbXBvcnQgeyBnZXRBc3NldEJ5SUQgfSBmcm9tICcuL0Fzc2V0UmVnaXN0cnknO1xuaW1wb3J0ICogYXMgQXNzZXRTb3VyY2VzIGZyb20gJy4vQXNzZXRTb3VyY2VzJztcbmltcG9ydCAqIGFzIEFzc2V0VXJpcyBmcm9tICcuL0Fzc2V0VXJpcyc7XG5pbXBvcnQgeyBnZXRFbWJlZGRlZEFzc2V0VXJpIH0gZnJvbSAnLi9FbWJlZGRlZEFzc2V0cyc7XG5pbXBvcnQgKiBhcyBJbWFnZUFzc2V0cyBmcm9tICcuL0ltYWdlQXNzZXRzJztcbmltcG9ydCB7IGRvd25sb2FkQXN5bmMsIElTX0VOVl9XSVRIX1VQREFURVNfRU5BQkxFRCB9IGZyb20gJy4vUGxhdGZvcm1VdGlscyc7XG5pbXBvcnQgcmVzb2x2ZUFzc2V0U291cmNlIGZyb20gJy4vcmVzb2x2ZUFzc2V0U291cmNlJztcblxudHlwZSBBc3NldERlc2NyaXB0b3IgPSB7XG4gIG5hbWU6IHN0cmluZztcbiAgdHlwZTogc3RyaW5nO1xuICBoYXNoPzogc3RyaW5nIHwgbnVsbDtcbiAgdXJpOiBzdHJpbmc7XG4gIHdpZHRoPzogbnVtYmVyIHwgbnVsbDtcbiAgaGVpZ2h0PzogbnVtYmVyIHwgbnVsbDtcbn07XG5cbnR5cGUgRG93bmxvYWRQcm9taXNlQ2FsbGJhY2tzID0ge1xuICByZXNvbHZlOiAoKSA9PiB2b2lkO1xuICByZWplY3Q6IChlcnJvcjogRXJyb3IpID0+IHZvaWQ7XG59O1xuXG5leHBvcnQgdHlwZSBBc3NldE1ldGFkYXRhID0gQXNzZXRTb3VyY2VzLkFzc2V0TWV0YWRhdGE7XG5cbmV4cG9ydCBjbGFzcyBBc3NldCB7XG4gIHN0YXRpYyBieUhhc2ggPSB7fTtcbiAgc3RhdGljIGJ5VXJpID0ge307XG5cbiAgbmFtZTogc3RyaW5nO1xuICB0eXBlOiBzdHJpbmc7XG4gIGhhc2g6IHN0cmluZyB8IG51bGwgPSBudWxsO1xuICB1cmk6IHN0cmluZztcbiAgbG9jYWxVcmk6IHN0cmluZyB8IG51bGwgPSBudWxsO1xuICB3aWR0aDogbnVtYmVyIHwgbnVsbCA9IG51bGw7XG4gIGhlaWdodDogbnVtYmVyIHwgbnVsbCA9IG51bGw7XG4gIGRvd25sb2FkaW5nOiBib29sZWFuID0gZmFsc2U7XG4gIGRvd25sb2FkZWQ6IGJvb2xlYW4gPSBmYWxzZTtcbiAgX2Rvd25sb2FkQ2FsbGJhY2tzOiBEb3dubG9hZFByb21pc2VDYWxsYmFja3NbXSA9IFtdO1xuXG4gIGNvbnN0cnVjdG9yKHsgbmFtZSwgdHlwZSwgaGFzaCA9IG51bGwsIHVyaSwgd2lkdGgsIGhlaWdodCB9OiBBc3NldERlc2NyaXB0b3IpIHtcbiAgICB0aGlzLm5hbWUgPSBuYW1lO1xuICAgIHRoaXMudHlwZSA9IHR5cGU7XG4gICAgdGhpcy5oYXNoID0gaGFzaDtcbiAgICB0aGlzLnVyaSA9IHVyaTtcblxuICAgIGlmICh0eXBlb2Ygd2lkdGggPT09ICdudW1iZXInKSB7XG4gICAgICB0aGlzLndpZHRoID0gd2lkdGg7XG4gICAgfVxuICAgIGlmICh0eXBlb2YgaGVpZ2h0ID09PSAnbnVtYmVyJykge1xuICAgICAgdGhpcy5oZWlnaHQgPSBoZWlnaHQ7XG4gICAgfVxuXG4gICAgaWYgKGhhc2gpIHtcbiAgICAgIHRoaXMubG9jYWxVcmkgPSBnZXRFbWJlZGRlZEFzc2V0VXJpKGhhc2gsIHR5cGUpO1xuICAgICAgaWYgKHRoaXMubG9jYWxVcmkpIHtcbiAgICAgICAgdGhpcy5kb3dubG9hZGVkID0gdHJ1ZTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAoUGxhdGZvcm0uT1MgPT09ICd3ZWInKSB7XG4gICAgICBpZiAoIW5hbWUpIHtcbiAgICAgICAgdGhpcy5uYW1lID0gQXNzZXRVcmlzLmdldEZpbGVuYW1lKHVyaSk7XG4gICAgICB9XG4gICAgICBpZiAoIXR5cGUpIHtcbiAgICAgICAgdGhpcy50eXBlID0gQXNzZXRVcmlzLmdldEZpbGVFeHRlbnNpb24odXJpKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBzdGF0aWMgbG9hZEFzeW5jKG1vZHVsZUlkOiBudW1iZXIgfCBudW1iZXJbXSB8IHN0cmluZyB8IHN0cmluZ1tdKTogUHJvbWlzZTxBc3NldFtdPiB7XG4gICAgY29uc3QgbW9kdWxlSWRzID0gQXJyYXkuaXNBcnJheShtb2R1bGVJZCkgPyBtb2R1bGVJZCA6IFttb2R1bGVJZF07XG4gICAgcmV0dXJuIFByb21pc2UuYWxsKG1vZHVsZUlkcy5tYXAobW9kdWxlSWQgPT4gQXNzZXQuZnJvbU1vZHVsZShtb2R1bGVJZCkuZG93bmxvYWRBc3luYygpKSk7XG4gIH1cblxuICBzdGF0aWMgZnJvbU1vZHVsZSh2aXJ0dWFsQXNzZXRNb2R1bGU6IG51bWJlciB8IHN0cmluZyk6IEFzc2V0IHtcbiAgICBpZiAodHlwZW9mIHZpcnR1YWxBc3NldE1vZHVsZSA9PT0gJ3N0cmluZycpIHtcbiAgICAgIHJldHVybiBBc3NldC5mcm9tVVJJKHZpcnR1YWxBc3NldE1vZHVsZSk7XG4gICAgfVxuXG4gICAgY29uc3QgbWV0YSA9IGdldEFzc2V0QnlJRCh2aXJ0dWFsQXNzZXRNb2R1bGUpO1xuICAgIGlmICghbWV0YSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBNb2R1bGUgXCIke3ZpcnR1YWxBc3NldE1vZHVsZX1cIiBpcyBtaXNzaW5nIGZyb20gdGhlIGFzc2V0IHJlZ2lzdHJ5YCk7XG4gICAgfVxuXG4gICAgLy8gT3V0c2lkZSBvZiB0aGUgbWFuYWdlZCBlbnYgd2UgbmVlZCB0aGUgbW9kdWxlSWQgdG8gaW5pdGlhbGl6ZSB0aGUgYXNzZXRcbiAgICAvLyBiZWNhdXNlIHJlc29sdmVBc3NldFNvdXJjZSBkZXBlbmRzIG9uIGl0XG4gICAgaWYgKCFJU19FTlZfV0lUSF9VUERBVEVTX0VOQUJMRUQpIHtcbiAgICAgIGNvbnN0IHsgdXJpIH0gPSByZXNvbHZlQXNzZXRTb3VyY2UodmlydHVhbEFzc2V0TW9kdWxlKTtcbiAgICAgIGNvbnN0IGFzc2V0ID0gbmV3IEFzc2V0KHtcbiAgICAgICAgbmFtZTogbWV0YS5uYW1lLFxuICAgICAgICB0eXBlOiBtZXRhLnR5cGUsXG4gICAgICAgIGhhc2g6IG1ldGEuaGFzaCxcbiAgICAgICAgdXJpLFxuICAgICAgICB3aWR0aDogbWV0YS53aWR0aCxcbiAgICAgICAgaGVpZ2h0OiBtZXRhLmhlaWdodCxcbiAgICAgIH0pO1xuXG4gICAgICAvLyBUT0RPOiBGaWxlU3lzdGVtIHNob3VsZCBwcm9iYWJseSBzdXBwb3J0ICdkb3dubG9hZGluZycgZnJvbSBkcmF3YWJsZVxuICAgICAgLy8gcmVzb3VyY2VzIEJ1dCBmb3Igbm93IGl0IGRvZXNuJ3QgKGl0IG9ubHkgc3VwcG9ydHMgcmF3IHJlc291cmNlcykgYW5kXG4gICAgICAvLyBSZWFjdCBOYXRpdmUncyBJbWFnZSB3b3JrcyBmaW5lIHdpdGggZHJhd2FibGUgcmVzb3VyY2UgbmFtZXMgZm9yXG4gICAgICAvLyBpbWFnZXMuXG4gICAgICBpZiAoUGxhdGZvcm0uT1MgPT09ICdhbmRyb2lkJyAmJiAhdXJpLmluY2x1ZGVzKCc6JykgJiYgKG1ldGEud2lkdGggfHwgbWV0YS5oZWlnaHQpKSB7XG4gICAgICAgIGFzc2V0LmxvY2FsVXJpID0gYXNzZXQudXJpO1xuICAgICAgICBhc3NldC5kb3dubG9hZGVkID0gdHJ1ZTtcbiAgICAgIH1cblxuICAgICAgQXNzZXQuYnlIYXNoW21ldGEuaGFzaF0gPSBhc3NldDtcbiAgICAgIHJldHVybiBhc3NldDtcbiAgICB9XG5cbiAgICByZXR1cm4gQXNzZXQuZnJvbU1ldGFkYXRhKG1ldGEpO1xuICB9XG5cbiAgc3RhdGljIGZyb21NZXRhZGF0YShtZXRhOiBBc3NldE1ldGFkYXRhKTogQXNzZXQge1xuICAgIC8vIFRoZSBoYXNoIG9mIHRoZSB3aG9sZSBhc3NldCwgbm90IHRvIGJlIGNvbmZ1c2VkIHdpdGggdGhlIGhhc2ggb2YgYSBzcGVjaWZpYyBmaWxlIHJldHVybmVkXG4gICAgLy8gZnJvbSBgc2VsZWN0QXNzZXRTb3VyY2VgXG4gICAgY29uc3QgbWV0YUhhc2ggPSBtZXRhLmhhc2g7XG4gICAgaWYgKEFzc2V0LmJ5SGFzaFttZXRhSGFzaF0pIHtcbiAgICAgIHJldHVybiBBc3NldC5ieUhhc2hbbWV0YUhhc2hdO1xuICAgIH1cblxuICAgIGNvbnN0IHsgdXJpLCBoYXNoIH0gPSBBc3NldFNvdXJjZXMuc2VsZWN0QXNzZXRTb3VyY2UobWV0YSk7XG4gICAgY29uc3QgYXNzZXQgPSBuZXcgQXNzZXQoe1xuICAgICAgbmFtZTogbWV0YS5uYW1lLFxuICAgICAgdHlwZTogbWV0YS50eXBlLFxuICAgICAgaGFzaCxcbiAgICAgIHVyaSxcbiAgICAgIHdpZHRoOiBtZXRhLndpZHRoLFxuICAgICAgaGVpZ2h0OiBtZXRhLmhlaWdodCxcbiAgICB9KTtcbiAgICBBc3NldC5ieUhhc2hbbWV0YUhhc2hdID0gYXNzZXQ7XG4gICAgcmV0dXJuIGFzc2V0O1xuICB9XG5cbiAgc3RhdGljIGZyb21VUkkodXJpOiBzdHJpbmcpOiBBc3NldCB7XG4gICAgaWYgKEFzc2V0LmJ5VXJpW3VyaV0pIHtcbiAgICAgIHJldHVybiBBc3NldC5ieVVyaVt1cmldO1xuICAgIH1cblxuICAgIC8vIFBvc3NpYmx5IGEgQmFzZTY0LWVuY29kZWQgVVJJXG4gICAgbGV0IHR5cGUgPSAnJztcbiAgICBpZiAodXJpLmluZGV4T2YoJztiYXNlNjQnKSA+IC0xKSB7XG4gICAgICB0eXBlID0gdXJpLnNwbGl0KCc7JylbMF0uc3BsaXQoJy8nKVsxXTtcbiAgICB9IGVsc2Uge1xuICAgICAgY29uc3QgZXh0ZW5zaW9uID0gQXNzZXRVcmlzLmdldEZpbGVFeHRlbnNpb24odXJpKTtcbiAgICAgIHR5cGUgPSBleHRlbnNpb24uc3RhcnRzV2l0aCgnLicpID8gZXh0ZW5zaW9uLnN1YnN0cmluZygxKSA6IGV4dGVuc2lvbjtcbiAgICB9XG5cbiAgICBjb25zdCBhc3NldCA9IG5ldyBBc3NldCh7XG4gICAgICBuYW1lOiAnJyxcbiAgICAgIHR5cGUsXG4gICAgICBoYXNoOiBudWxsLFxuICAgICAgdXJpLFxuICAgIH0pO1xuXG4gICAgQXNzZXQuYnlVcmlbdXJpXSA9IGFzc2V0O1xuXG4gICAgcmV0dXJuIGFzc2V0O1xuICB9XG5cbiAgYXN5bmMgZG93bmxvYWRBc3luYygpOiBQcm9taXNlPHRoaXM+IHtcbiAgICBpZiAodGhpcy5kb3dubG9hZGVkKSB7XG4gICAgICByZXR1cm4gdGhpcztcbiAgICB9XG4gICAgaWYgKHRoaXMuZG93bmxvYWRpbmcpIHtcbiAgICAgIGF3YWl0IG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgdGhpcy5fZG93bmxvYWRDYWxsYmFja3MucHVzaCh7IHJlc29sdmUsIHJlamVjdCB9KTtcbiAgICAgIH0pO1xuICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuICAgIHRoaXMuZG93bmxvYWRpbmcgPSB0cnVlO1xuXG4gICAgdHJ5IHtcbiAgICAgIGlmIChQbGF0Zm9ybS5PUyA9PT0gJ3dlYicpIHtcbiAgICAgICAgaWYgKEltYWdlQXNzZXRzLmlzSW1hZ2VUeXBlKHRoaXMudHlwZSkpIHtcbiAgICAgICAgICBjb25zdCB7IHdpZHRoLCBoZWlnaHQsIG5hbWUgfSA9IGF3YWl0IEltYWdlQXNzZXRzLmdldEltYWdlSW5mb0FzeW5jKHRoaXMudXJpKTtcbiAgICAgICAgICB0aGlzLndpZHRoID0gd2lkdGg7XG4gICAgICAgICAgdGhpcy5oZWlnaHQgPSBoZWlnaHQ7XG4gICAgICAgICAgdGhpcy5uYW1lID0gbmFtZTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICB0aGlzLm5hbWUgPSBBc3NldFVyaXMuZ2V0RmlsZW5hbWUodGhpcy51cmkpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICB0aGlzLmxvY2FsVXJpID0gYXdhaXQgZG93bmxvYWRBc3luYyh0aGlzLnVyaSwgdGhpcy5oYXNoLCB0aGlzLnR5cGUsIHRoaXMubmFtZSk7XG5cbiAgICAgIHRoaXMuZG93bmxvYWRlZCA9IHRydWU7XG4gICAgICB0aGlzLl9kb3dubG9hZENhbGxiYWNrcy5mb3JFYWNoKCh7IHJlc29sdmUgfSkgPT4gcmVzb2x2ZSgpKTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICB0aGlzLl9kb3dubG9hZENhbGxiYWNrcy5mb3JFYWNoKCh7IHJlamVjdCB9KSA9PiByZWplY3QoZSkpO1xuICAgICAgdGhyb3cgZTtcbiAgICB9IGZpbmFsbHkge1xuICAgICAgdGhpcy5kb3dubG9hZGluZyA9IGZhbHNlO1xuICAgICAgdGhpcy5fZG93bmxvYWRDYWxsYmFja3MgPSBbXTtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXM7XG4gIH1cbn1cbiJdLCJzb3VyY2VSb290IjoiIn0=